<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:th="http://www.thymeleaf.org"
	layout:decorate="~{fragments/layout}">

<head th:replace="fragments/layout.html :: html_head" />

<body class="hold-transition sidebar-mini">
	<div class="wrapper">
		<div th:replace="fragments/layout.html :: nav_menu" />
		<div th:replace="fragments/layout.html :: sidebar" />

		<div class="content-wrapper">
			<!-- Content Header (Page header) -->
			<div class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1 class="m-0">Create New Job Posting</h1>
						</div><!-- /.col -->
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#">Home</a></li>
								<li class="breadcrumb-item"><a th:href="@{/jobpost/list}">Job Posts</a></li>
								<li class="breadcrumb-item active">Create</li>
							</ol>
						</div>
					</div><!-- /.row -->
				</div><!-- /.container-fluid -->
			</div>
			<!-- /.content-header -->

			<!-- Main content -->
			<div class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-body">
									<h1 th:value="${testrate}">
									</h1>
									<form action="#" th:action="@{'/jobpost/create'}" th:object="${jobPostForm}"
										method="post">

										<div class="mb-3 form-group">
											<label class="form-label">Title</label>
											<input th:field="*{title}" type="text" class="form-control" required>
										</div>

										<div class="mb-3 form-group">
											<label class="form-label">Description</label>
											<textarea th:field="*{description}" type="text" class="form-control"
												required></textarea>
										</div>

										<div class="form-group align-items-bottom">
											<label class="form-label">Date and Time of Job</label>
											<div class="form-row align-items-top">
												<div class="col">
													<div class="input-group">
														<div class="input-group-prepend">
															<span class="input-group-text">Start Date</span>
														</div>
														<input th:field="*{startDate}" id="startDate" type="date" class="form-control"
															onchange="validateFields()" required />
													</div>
													<div id="startDate-feedback" class="invalid-feedback d-block">
													</div>
												</div>

												<div class="col-auto">
													<div class="input-group">
														<div class="input-group-prepend">
															<span class="input-group-text">Start Time</span>
														</div>
														<select th:field="*{startTimeHour}" type="text"
															class="form-control" onchange="validateFields()" required>
															<option value="01">01</option>
															<option value="02">02</option>
															<option value="03">03</option>
															<option value="04">04</option>
															<option value="05">05</option>
															<option value="06">06</option>
															<option value="07">07</option>
															<option value="08">08</option>
															<option value="09">09</option>
															<option value="10">10</option>
															<option value="11">11</option>
															<option value="12">12</option>
														</select>
														<div class="input-group-prepend">
															<span class="input-group-text">:</span>
														</div>
														<select th:field="*{startTimeMin}" type="text"
															class="form-control" onchange="validateFields()" required>
															<option value="00">00</option>
															<option value="30">30</option>
														</select>
														<select th:field="*{startTimeAmPm}" type="text"
															class="form-control" onchange="validateFields()" required>
															<option value="AM">AM</option>
															<option value="PM">PM</option>
														</select>
													</div>
													<div id="startTime-feedback" class="invalid-feedback d-block">
													</div>
												</div>

												<div class="col-auto">
													<div class="input-group">
														<span class="mt-2">to</span>
													</div>
												</div>

												<div class="col">
													<div class="input-group">
														<div class="input-group-prepend">
															<span class="input-group-text">End Date</span>
														</div>
														<input th:field="*{endDate}" type="date" class="form-control"
															onchange="validateFields()" required />
													</div>
													<div id="endDate-feedback" class="invalid-feedback d-block">
													</div>
												</div>

												<div class="col-auto">
													<div class="input-group">
														<div class="input-group-prepend">
															<span class="input-group-text">End Time</span>
														</div>
														<select th:field="*{endTimeHour}" type="text"
															class="form-control" onchange="validateFields(); " required>
															<option value="01">01</option>
															<option value="02">02</option>
															<option value="03">03</option>
															<option value="04">04</option>
															<option value="05">05</option>
															<option value="06">06</option>
															<option value="07">07</option>
															<option value="08">08</option>
															<option value="09">09</option>
															<option value="10">10</option>
															<option value="11">11</option>
															<option value="12">12</option>
														</select>
														<div class="input-group-prepend">
															<span class="input-group-text">:</span>
														</div>
														<select th:field="*{endTimeMin}" type="text"
															class="form-control" onchange="validateFields()" required>
															<option value="00">00</option>
															<option value="30">30</option>
														</select>
														<select th:field="*{endTimeAmPm}" type="text"
															class="form-control" onchange="validateFields()" required>
															<option value="AM">AM</option>
															<option value="PM">PM</option>
														</select>
													</div>
													<div id="endTime-feedback" class="invalid-feedback d-block">
													</div>
												</div>
											</div>
										</div>

										<div class="row">
											<div class="mb-3 form-group col-xl-6">
												<label class="form-label">Clinic</label>
												<select th:field="*{clinicId}" class="form-control" required>
													<option value="" selected hidden>Please select a clinic</option>
													<option th:each="c : ${clinics}" th:value="${c.id}"
														th:text="${c.name}">
														Clinics</option>
												</select>
											</div>
										</div>

										<div class="form-row align-items-top">
											<div class="form-group col-xl-6">
												<label class="form-label">Rate/hour</label>
												<div class="input-group">
													<div class="input-group-prepend">
														<span class="input-group-text">$</span>
													</div>
													<input th:field="*{ratePerHour}" type="number" min="0" step="0.01"
														class="form-control" onkeyup="validateFields()" oninput="checkTrend()" required />
													<div class="input-group-append">
														<span class="input-group-text mt-10">x</span>
														<span id="totalHours" class="input-group-text">? hours</span>
														<span class="input-group-text">=</span>
														<span class="input-group-text">$</span>
														<input id="totalRate" type="text"
															class="form-control input-group-text" value="?" readonly />
													</div>
												</div>
												<div id="ratePerHour-trend-feedback"></div>
												<div id="ratePerHour-feedback" class="invalid-feedback d-block"></div>
												</div>
											</div>
										</div>
										<button type="submit" class="btn btn-info">Create</button>
									</form>
								</div>
							</div>
						</div>
						<!-- /.col -->
					</div>
				</div><!-- /.container-fluid -->
			</div>
			<!-- /.content -->
		</div>
		<div th:replace="fragments/layout.html :: footer" />
		<div th:replace="fragments/layout.html :: script" />
	</div>
</body>
<script th:inline="javascript">
	function validateFields() {
		var startElem = document.getElementById("startDate");
		var endElem = document.getElementById("endDate");
		var rateElem = document.getElementById("ratePerHour");

		var startTimeHourElem = document.getElementById("startTimeHour");
		var startTimeMinElem = document.getElementById("startTimeMin");
		var startTimeAmPmElem = document.getElementById("startTimeAmPm");

		var endTimeHourElem = document.getElementById("endTimeHour");
		var endTimeMinElem = document.getElementById("endTimeMin");
		var endTimeAmPmElem = document.getElementById("endTimeAmPm");

		var startDate = new Date(startElem.value);
		var startTimeHour = parseInt(startTimeHourElem.value);
		var startTimeMin = parseInt(startTimeMinElem.value);
		var startTimeAmPm = startTimeAmPmElem.value;
		if (startTimeAmPm == "PM") {
			startDate.setHours(startTimeHour + 12, startTimeMin, 0);
		} else {
			startDate.setHours(startTimeHour, startTimeMin, 0);
		}

		var endDate = new Date(endElem.value);
		var endTimeHour = parseInt(endTimeHourElem.value);
		var endTimeMin = parseInt(endTimeMinElem.value);
		var endTimeAmPm = endTimeAmPmElem.value;
		if (endTimeAmPm == "PM" && endTimeHour != 12) {
			endDate.setHours(endTimeHour + 12, endTimeMin, 0);
		} else {
			endDate.setHours(endTimeHour, endTimeMin, 0);
		}

		var startFeedbackElem = document.getElementById("startDate-feedback");
		if (startElem.value == "") {
			startFeedbackElem.innerHTML = "Please enter start date and time.";
			startElem.classList.add("is-invalid");
			resetTotalRate();
		} else {
			startElem.classList.remove("is-invalid");
			startFeedbackElem.innerHTML = "";
		}

		var endFeedbackElem = document.getElementById("endDate-feedback");
		if (endElem.value == "") {
			endFeedbackElem.innerHTML = "Please enter end date and time.";
			endElem.classList.add("is-invalid");
			resetTotalRate();
		} else {
			endElem.classList.remove("is-invalid");
			endFeedbackElem.innerHTML = "";
		}

		var diff = endDate.getTime() - startDate.getTime();

		if (diff < 0 && endDate.toLocaleDateString() != startDate.toLocaleDateString()) {
			endElem.classList.add("is-invalid");
			startElem.classList.add("is-invalid");
			endFeedbackElem.innerHTML = "End date cannot be earlier than start date.";
			startFeedbackElem.innerHTML = "Start date cannot be same or later than end date.";
			resetTotalRate();
		} else if (endDate.toLocaleDateString() == startDate.toLocaleDateString()) {
			if (startTimeHour - endTimeHour > 0 ||
				startTimeHour == endTimeHour && startTimeMin - endTimeMin >= 0
			) {
				if (startTimeAmPm == "PM" && endTimeAmPm == "AM" || startTimeAmPm == endTimeAmPm) {
					startTimeHourElem.classList.add("is-invalid");
					startTimeMinElem.classList.add("is-invalid");
					startTimeAmPmElem.classList.add("is-invalid");
					endTimeHourElem.classList.add("is-invalid");
					endTimeMinElem.classList.add("is-invalid");
					endTimeAmPmElem.classList.add("is-invalid");
					document.getElementById("endTime-feedback").innerHTML = "End time cannot be same or earlier than start time.";
					document.getElementById("startTime-feedback").innerHTML = "Start time cannot be same or later than end time.";
					resetTotalRate();
				}
				else {
					resetTimeError();
				}
			}
			else {
				resetTimeError();
			}
		} else {
			resetTimeError();
		}

		var rateFeedbackElem = document.getElementById("ratePerHour-feedback");
		if (isNaN(rateElem.valueAsNumber)) {
			rateElem.classList.add("is-invalid");
			rateFeedbackElem.innerHTML = "Please enter a valid number";
			resetTotalRate();
		} else {
			rateElem.classList.remove("is-invalid");
			rateFeedbackElem.innerHTML = "";
		}
		calculateTotalRate(
			getDuration(
				startDate,
				endDate,
			),
			rateElem.valueAsNumber);
	}
	
	function checkTrend(){
		var userDateInput = document.getElementById("startDate");
		console.log(userDateInput.value)
		var rateElem = document.getElementById("ratePerHour");
		if (userDateInput.value){
			var converted = new Date(startDate.value);
			var dayNumber = converted.getDay();
			var rate_per_hour_feedback = document.getElementById("ratePerHour-trend-feedback");
			rate_per_hour_feedback.innerHTML = '';
			var weekdayrate = /*[[${weekdayTrend}]]*/ null;
			var weekdayrate = parseFloat(weekdayrate);
			var weekendrate = /*[[${weekendTrend}]]*/ null;
			var weekendrate = parseFloat(weekendrate);
			if (dayNumber == 0 || dayNumber == 6){
				console.log((rateElem.valueAsNumber / weekendrate));
				if ((rateElem.valueAsNumber / weekendrate) < 0.8 ){
					rate_per_hour_feedback.innerHTML = 'Your proposed rate is substantially lower than the recent average trending rate for weekend ($' + weekendrate.toFixed(2) + "). You may wish to reconsider again to ensure a higher chance of the job post being filled.";
					rate_per_hour_feedback.className= "text-danger";
				}
			}
			else{
				if ((rateElem.valueAsNumber / weekdayrate) < 0.8 ){
					rate_per_hour_feedback.innerHTML = 'Your proposed rate is substantially lower than the recent average trending rate for weekday ($' + weekdayrate.toFixed(2) + "). You may wish to reconsider again to ensure a higher chance of the job post being filled.";
					rate_per_hour_feedback.className= "text-danger";
				}		
			}
		}
	}

	function getDuration(
		startDate,
		endDate,
	) {
		var msec = endDate.getTime() - startDate.getTime();
		return msec;
	}

	function resetTimeError() {
		document.getElementById("startTimeHour").classList.remove("is-invalid");
		document.getElementById("startTimeMin").classList.remove("is-invalid");
		document.getElementById("startTimeAmPm").classList.remove("is-invalid");
		document.getElementById("endTimeHour").classList.remove("is-invalid");
		document.getElementById("endTimeMin").classList.remove("is-invalid");
		document.getElementById("endTimeAmPm").classList.remove("is-invalid");
		document.getElementById("endTime-feedback").innerHTML = "";
		document.getElementById("startTime-feedback").innerHTML = "";
	}

	function resetTotalRate() {
		document.getElementById("totalHours").innerHTML = "? hours";
		document.getElementById("totalRate").value = "?";
	}

	function calculateTotalRate(duration, rate) {
		if (duration <= 0 || isNaN(rate) || isNaN(duration)) {
			resetTotalRate();
			return;
		}
		var totalHours = duration / 1000 / 60 / 60;
		document.getElementById("totalHours").innerHTML = totalHours + " hours";
		document.getElementById("totalRate").value = (Math.round(totalHours * rate * 100) / 100).toFixed(2);
	}
</script>

</html>